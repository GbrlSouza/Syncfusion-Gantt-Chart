<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gantt Chart</title>
  <script src="https://cdn.syncfusion.com/ej2/20.3.56/dist/ej2.min.js"></script>
  <link rel="stylesheet" href="https://cdn.syncfusion.com/ej2/20.3.56/material.css">
</head>

<body>
  <div id="gantt"></div>
  <script>
    async function fetchTasks() {
      const response = await fetch('/tasks');
      return await response.json();
    }

    async function updateTasks(tasks) {
      await fetch('/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tasks)
      });
    }

    async function initGantt() {
      const tasks = await fetchTasks();
      const ganttData = tasks.map(task => ({
        TaskID: task.id,
        TaskName: task.name,
        StartDate: new Date(task.start_date),
        EndDate: new Date(task.end_date),
        Progress: parseFloat(task.progress)
      }));

      new ej.gantt.Gantt({
        dataSource: ganttData,
        height: '450px',
        taskFields: {
          id: 'TaskID',
          name: 'TaskName',
          startDate: 'StartDate',
          endDate: 'EndDate',
          progress: 'Progress'
        },
        editSettings: {
          allowEditing: true,
          allowAdding: true,
          allowDeleting: true,
        },
        toolbar: ['Add', 'Edit', 'Delete', 'Update', 'Cancel'],
        actionComplete: async (args) => {
          if (args.requestType === 'save' || args.requestType === 'delete') {
            const updatedTasks = ganttData.map(task => ({
              id: task.TaskID,
              name: task.TaskName,
              start_date: task.StartDate.toISOString().split('T')[0],
              end_date: task.EndDate.toISOString().split('T')[0],
              progress: task.Progress.toString()
            }));
            await updateTasks(updatedTasks);
          }
        }
      }).appendTo('#gantt');
    }

    initGantt();
  </script>
</body>

</html>